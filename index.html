<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D 5e Monster Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
    /* fonts */
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap');

        body {
            font-family: "Playfair Display", serif;
        }

        /* Dark mode overrides */
        body.dark {
            background-color: #1f2937;
            color: #f9fafb;
        }

        body.dark .bg-white {
            background-color: #374151;
            color: #f9fafb;
        }

        body.dark .text-black {
            color: #f9fafb;
        }

        body.dark .border {
            border-color: #4b5563;
        }

        body.dark input,
        body.dark button,
        body.dark textarea,
        body.dark select {
            background-color: #4b5563;
            color: #f9fafb;
        }

        body.dark .health-bar {
            background-color: #4b5563;
        }

        body.dark #monsterSuggestions {
            background-color: #374151;
            border-color: #4b5563;
        }

        body.dark #monsterSuggestions div:hover {
            background-color: #4b5563;
        }

        body.dark .ac-display,
        body.dark .initiative-display,
        body.dark .hp-display {
            background-color: #4b5563;
            color: #f9fafb;
            border-color: #6b7280;
        }

        body.dark .ac-display:hover,
        body.dark .initiative-display:hover,
        body.dark .hp-display:hover {
            background-color: #6b7280;
        }

        .health-bar {
            display: flex;
            height: 20px;
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .health-segment {
            flex: 1;
            background-color: #22c55e;
            border-right: 1px solid #fff;
        }

        .health-segment:last-child {
            border-right: none;
        }

        .empty-segment {
            background-color: #e5e7eb;
        }

        #monsterSuggestions {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            z-index: 10;
        }

        #monsterSuggestions div {
            padding: 8px;
            cursor: pointer;
        }

        #monsterSuggestions div:hover {
            background-color: #f3f4f6;
        }

        /* Dark mode toggle switch styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch #darkModeInput {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #2196f3;
            -webkit-transition: 0.4s;
            transition: 0.4s;
            z-index: 0;
            overflow: hidden;
        }

        .sun-moon {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: yellow;
            -webkit-transition: 0.4s;
            transition: 0.4s;
        }

        #darkModeInput:checked + .slider {
            background-color: black;
        }

        #darkModeInput:focus + .slider {
            box-shadow: 0 0 1px #2196f3;
        }

        #darkModeInput:checked + .slider .sun-moon {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
            background-color: white;
            -webkit-animation: rotate-center 0.6s ease-in-out both;
            animation: rotate-center 0.6s ease-in-out both;
        }

        .moon-dot {
            opacity: 0;
            transition: 0.4s;
            fill: gray;
        }

        #darkModeInput:checked + .slider .moon-dot {
            opacity: 1;
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round .sun-moon {
            border-radius: 50%;
        }

        #moon-dot-1 {
            left: 10px;
            top: 3px;
            position: absolute;
            width: 6px;
            height: 6px;
            z-index: 4;
        }

        #moon-dot-2 {
            left: 2px;
            top: 10px;
            position: absolute;
            width: 10px;
            height: 10px;
            z-index: 4;
        }

        #moon-dot-3 {
            left: 16px;
            top: 18px;
            position: absolute;
            width: 3px;
            height: 3px;
            z-index: 4;
        }

        #light-ray-1 {
            left: -8px;
            top: -8px;
            position: absolute;
            width: 43px;
            height: 43px;
            z-index: -1;
            fill: white;
            opacity: 10%;
        }

        #light-ray-2 {
            left: -50%;
            top: -50%;
            position: absolute;
            width: 55px;
            height: 55px;
            z-index: -1;
            fill: white;
            opacity: 10%;
        }

        #light-ray-3 {
            left: -18px;
            top: -18px;
            position: absolute;
            width: 60px;
            height: 60px;
            z-index: -1;
            fill: white;
            opacity: 10%;
        }

        .cloud-light {
            position: absolute;
            fill: #eee;
            animation-name: cloud-move;
            animation-duration: 6s;
            animation-iteration-count: infinite;
        }

        .cloud-dark {
            position: absolute;
            fill: #ccc;
            animation-name: cloud-move;
            animation-duration: 6s;
            animation-iteration-count: infinite;
            animation-delay: 1s;
        }

        #cloud-1 {
            left: 30px;
            top: 15px;
            width: 40px;
        }

        #cloud-2 {
            left: 44px;
            top: 10px;
            width: 20px;
        }

        #cloud-3 {
            left: 18px;
            top: 24px;
            width: 30px;
        }

        #cloud-4 {
            left: 36px;
            top: 18px;
            width: 40px;
        }

        #cloud-5 {
            left: 48px;
            top: 14px;
            width: 20px;
        }

        #cloud-6 {
            left: 22px;
            top: 26px;
            width: 30px;
        }

        @keyframes cloud-move {
            0% { transform: translateX(0px); }
            40% { transform: translateX(4px); }
            80% { transform: translateX(-4px); }
            100% { transform: translateX(0px); }
        }

        .stars {
            transform: translateY(-32px);
            opacity: 0;
            transition: 0.4s;
        }

        .star {
            fill: white;
            position: absolute;
            -webkit-transition: 0.4s;
            transition: 0.4s;
            animation-name: star-twinkle;
            animation-duration: 2s;
            animation-iteration-count: infinite;
        }

        #darkModeInput:checked + .slider .stars {
            -webkit-transform: translateY(0);
            -ms-transform: translateY(0);
            transform: translateY(0);
            opacity: 1;
        }

        #star-1 {
            width: 20px;
            top: 2px;
            left: 3px;
            animation-delay: 0.3s;
        }

        #star-2 {
            width: 6px;
            top: 16px;
            left: 3px;
        }

        #star-3 {
            width: 12px;
            top: 20px;
            left: 10px;
            animation-delay: 0.6s;
        }

        #star-4 {
            width: 18px;
            top: 0px;
            left: 18px;
            animation-delay: 1.3s;
        }

        @keyframes star-twinkle {
            0% { transform: scale(1); }
            40% { transform: scale(1.2); }
            80% { transform: scale(0.8); }
            100% { transform: scale(1); }
        }

        /* Simple/Advanced mode text toggle styles */
        .mode-toggle {
            cursor: pointer;
            font-size: 14px;
            font-weight: medium;
            color: #1f2937;
            user-select: none;
        }

        body.dark .mode-toggle {
            color: #f9fafb;
        }

        .mode-toggle .simple-label {
            opacity: 1;
            transition: opacity 0.3s;
        }

        .mode-toggle .advanced-label {
            opacity: 0.5;
            transition: opacity 0.3s;
        }

        .mode-toggle.advanced .simple-label {
            opacity: 0.5;
        }

        .mode-toggle.advanced .advanced-label {
            opacity: 1;
        }

        .mode-toggle:hover .simple-label,
        .mode-toggle:hover .advanced-label {
            opacity: 0.8;
        }

        /* Full/Compact mode text toggle styles */
        .compact-toggle {
            cursor: pointer;
            font-size: 14px;
            font-weight: medium;
            color: #1f2937;
            user-select: none;
        }

        body.dark .compact-toggle {
            color: #f9fafb;
        }

        .compact-toggle .full-label {
            opacity: 1;
            transition: opacity 0.3s;
        }

        .compact-toggle .compact-label {
            opacity: 0.5;
            transition: opacity 0.3s;
        }

        .compact-toggle.compact .full-label {
            opacity: 0.5;
        }

        .compact-toggle.compact .compact-label {
            opacity: 1;
        }

        .compact-toggle:hover .full-label,
        .compact-toggle:hover .compact-label {
            opacity: 0.8;
        }

        .hp-display {
            cursor: pointer;
            background-color: #e5e7eb;
            color: #1f2937;
            padding: 2px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            transition: background-color 0.2s;
            position: relative;
        }

        .hp-display:hover {
            background-color: #d1d5db;
        }

        .hp-display input {
            background-color: #e5e7eb;
            color: #1f2937;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 1px 4px;
            width: 64px;
        }

        body.dark .hp-display input {
            background-color: #4b5563;
            color: #f9fafb;
            border-color: #6b7280;
        }

        .initiative-display,
        .ac-display {
            cursor: pointer;
            background-color: #e5e7eb;
            color: #1f2937;
            padding: 2px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .initiative-display:hover,
        .ac-display:hover {
            background-color: #d1d5db;
        }

        .monster-name {
            cursor: pointer;
            transition: color 0.2s;
        }

        .monster-name:hover {
            color: #3b82f6;
        }

        body.dark .monster-name:hover {
            color: #60a5fa;
        }

        .remove-button {
            color: #ef4444;
            transition: color 0.2s;
        }

        .remove-button:hover {
            color: #b91c1c;
        }

        .remove-button svg {
            width: 24px;
            height: 24px;
        }

        .ver {
            opacity: 30%;
            text-align: center;
            font-size: 70%;
        }

        #changelogBox {
            font-family: sans-serif;
        }

        /* Border styles for Player and NPC */
        .player-border {
            border: 2px solid #3b82f6;
        }

        .npc-border {
            border: 2px solid #a16207;
        }

        .custom-border {
            border: 2px solid var(--custom-border-color, transparent) !important;
        }

        .notes-textarea {
            resize: vertical;
            min-height: 40px;
            max-height: 100px;
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 4px;
            font-family: "DM Sans";
        }

        body.dark .notes-textarea {
            border-color: #4b5563;
        }

        #settingsPanel {
            position: absolute;
            top: 60px;
            right: 20px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 16px;
            z-index: 20;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body.dark #settingsPanel {
            background: #374151;
            border-color: #4b5563;
        }

        .details-popup .details-content .dice {
            text-decoration: underline;
        }

        .settings-button {
            color: #1f2937;
            transition: color 0.2s;
        }

        body.dark .settings-button {
            color: #f9fafb;
        }

        .settings-button:hover {
            color: #3b82f6;
        }

        .settings-button svg {
            width: 24px;
            height: 24px;
        }

        body.compact .container {
            max-width: 700px;
            padding: 4px !important;
        }

        body.compact .text-2xl {
            font-size: 1.125rem !important;
        }

        body.compact .text-lg {
            font-size: 0.875rem !important;
        }

        body.compact .text-base {
            font-size: 0.75rem !important;
        }

        body.compact .p-4 {
            padding: 6px !important;
        }

        body.compact .p-2 {
            padding: 2px !important;
        }

        body.compact .rounded-lg {
            border-radius: 2px !important;
        }

        body.compact .mb-6 {
            margin-bottom: 8px !important;
        }

        body.compact .mb-4 {
            margin-bottom: 6px !important;
        }

        body.compact .space-y-4 {
            gap: 6px !important;
        }

        body.compact .gap-4 {
            gap: 4px !important;
        }

        body.compact .w-24 {
            width: 56px !important;
        }

        body.compact .health-bar {
            height: 10px !important;
        }

        body.compact .notes-textarea {
            min-height: 20px !important;
            max-height: 48px !important;
            font-size: 0.75rem !important;
            padding: 2px !important;
        }

        body.compact .settings-button svg,
        body.compact .remove-button svg,
        body.compact .initiative-display,
        body.compact .ac-display,
        body.compact .hp-display {
            scale: 0.9;
        }

        body.compact .initiative-display,
        body.compact .ac-display,
        body.compact .hp-display {
            padding: 1px 4px !important;
            font-size: 0.75rem !important;
        }

        body.compact input,
        body.compact select {
            padding: 2px 4px !important;
            font-size: 0.75rem !important;
        }

        .monster-header {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
            position: relative;
        }

        @media (min-width: 640px) {
            .monster-header {
                flex-direction: row;
                align-items: center;
            }
        }

        .monster-header .ac-initiative {
            display: flex;
            flex-direction: row;
            gap: 8px;
        }

        /* HP Popup styles */
        .hp-popup {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 50;
            width: 240px;
            font-family: "DM Sans";
        }

        body.dark .hp-popup {
            background-color: #374151;
            color: #f9fafb;
        }

        .hp-popup .hp-input {
            background-color: #e5e7eb;
            color: #1f2937;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 2px 4px;
            width: 60px;
            text-align: center;
            margin: 4px auto;
            display: block;
            font-size: 0.75rem;
        }

        body.dark .hp-popup .hp-input {
            background-color: #4b5563;
            color: #f9fafb;
            border-color: #6b7280;
        }

        .hp-popup .hp-buttons {
            display: flex;
            flex-wrap: nowrap;
            gap: 4px;
            justify-content: center;
        }

        .hp-popup .hp-buttons button {
            padding: 4px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .hp-popup .hp-buttons .decrement {
            background-color: #ef4444;
            color: white;
        }

        .hp-popup .hp-buttons .decrement:hover {
            background-color: #b91c1c;
        }

        .hp-popup .hp-buttons .increment {
            background-color: #22c55e;
            color: white;
        }

        .hp-popup .hp-buttons .increment:hover {
            background-color: #16a34a;
        }

        .hp-popup .hp-buttons .set {
            background-color: #3b82f6;
            color: white;
        }

        .hp-popup .hp-buttons .set:hover {
            background-color: #2563eb;
        }

        /* Monster Details Popup styles */
        .details-popup {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: white;
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 50;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
        }

        body.dark .details-popup {
            background-color: #374151;
            color: #f9fafb;
        }

        .details-popup .details-content {
            font-size: 0.75rem;
            line-height: 1.25rem;
        }

        .details-popup .details-content h4 {
            font-weight: bold;
            margin-top: 8px;
            margin-bottom: 4px;
        }

        .details-popup .details-content p {
            margin-bottom: 4px;
            font-family: "DM Sans";
        }

        .details-popup .details-content ul {
            list-style-type: disc;
            margin-left: 16px;
            margin-bottom: 4px;
        }

        .details-popup .details-content li {
            margin-bottom: 2px;
            font-family: "DM Sans";
        }

        .details-icon {
            width: 16px;
            height: 16px;
            margin-left: 4px;
            vertical-align: middle;
            cursor: pointer;
            opacity: 50%;
        }

        .details-icon:hover {
            opacity: 100%;
            color: #3b82f6;
        }

        .monster-name-container {
            display: inline-flex;
            align-items: center;
        }

        /* Encounter group styles */
        .encounter-group {
            margin-bottom: 16px;
            background-color: #f9fafb;
            border-radius: 4px;
            padding: 8px;
        }

        body.dark .encounter-group {
            background-color: #2d3748;
        }

        .encounter-group h2 {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #1f2937;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body.dark .encounter-group h2 {
            color: #f9fafb;
        }

        .encounter-group.ungrouped h2 {
            display: none;
        }

        .encounter-group.collapsed .encounter-monsters {
            display: none;
        }

        .encounter-toggle-icon {
            width: 20px;
            height: 20px;
            transition: transform 0.2s;
        }

        .encounter-group.collapsed .encounter-toggle-icon {
            transform: rotate(-90deg);
        }

        .floating-add-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #3b82f6;
            color: white;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            z-index: 30;
            transition: background-color 0.2s;
        }

        .floating-add-button:hover {
            background-color: #2563eb;
        }

        body.dark .floating-add-button {
            background-color: #60a5fa;
        }

        body.dark .floating-add-button:hover {
            background-color: #3b82f6;
        }

        /* Update the add monster form container to be hidden by default */
        #addMonsterFormContainer {
            display: none; /* Hidden by default */
        }

        #addMonsterForm .add-button-container {
            display: flex;
            justify-content: flex-end;
        }

        /* Mode Selection Pop-up Styles */
        #modeSelectionPopup, #seedCodeModal, #messageBoxModal, #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 100;
            font-family: "DM Sans";
        }

        #modeSelectionPopup .popup-content,
        #seedCodeModal .modal-content,
        #messageBoxModal .message-content {
            background-color: white;
            padding: 32px;
            border-radius: 8px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        body.dark #modeSelectionPopup .popup-content,
        body.dark #seedCodeModal .modal-content,
        body.dark #messageBoxModal .message-content {
             background-color: #374151;
             color: #f9fafb;
        }

        #modeSelectionPopup h2,
        #seedCodeModal h2,
        #messageBoxModal h2 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 16px;
            font-family: "Playfair Display";
        }

        #modeSelectionPopup .mode-option {
            margin-bottom: 16px;
            text-align: left;
        }

        #modeSelectionPopup .mode-option label {
            display: block;
            margin-bottom: 8px;
            cursor: pointer;
            font-family: "Playfair Display";
        }

         #modeSelectionPopup .mode-option input[type="radio"] {
             margin-right: 8px;
         }

        #modeSelectionPopup .mode-option p {
            font-size: 0.875rem;
            color: #4b5563;
        }

        body.dark #modeSelectionPopup .mode-option p {
             color: #d1d5db;
        }

        #modeSelectionPopup .never-show {
            margin-top: 24px;
            margin-bottom: 24px;
            text-align: left;
        }

        #modeSelectionPopup button,
        #seedCodeModal button,
        #messageBoxModal button {
            background-color: #3b82f6;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #modeSelectionPopup button:hover,
        #seedCodeModal button:hover,
        #messageBoxModal button:hover {
            background-color: #2563eb;
        }

        #seedCodeTextarea {
            width: 100%;
            height: 150px;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            margin-bottom: 16px;
            resize: vertical;
            font-family: "DM Sans";
        }

        body.dark #seedCodeTextarea {
            background-color: #4b5563;
            color: #f9fafb;
            border-color: #6b7280;
        }

        .flex-row-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 10px;
        }

        /* Loading Spinner Styles */
        .spinner {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="modeSelectionPopup" class="hidden">
        <div class="popup-content">
            <h2>Choose Your Mode</h2>
            <div class="mode-option">
                <label for="simpleModeRadio">
                    <input type="radio" id="simpleModeRadio" name="startMode" value="simple" checked>
                    Simple Mode
                </label>
                <p><u>Focus on the essentials:</u> Monster Name, HP, AC, and Initiative. Quick and easy tracking for combat.</p>
            </div>
            <div class="mode-option">
                <label for="advancedModeRadio">
                    <input type="radio" id="advancedModeRadio" name="startMode" value="advanced">
                    Advanced Mode
                </label>
                <p><u>More in-depth features:</u> Add Players/NPCs, customize border colors, add notes, and group monsters by encounter.</p>
               <br><p><i>Note: This setting can be changed at any time in the settings menu!</i></p>
            </div>
            <div class="never-show">
                <label for="neverShowAgainCheckbox">
                    <input type="checkbox" id="neverShowAgainCheckbox">
                    Never show this again
                </label>
            </div>
            <button id="getStartedButton">Get Started</button>
        </div>
    </div>

    <div id="seedCodeModal" class="hidden" style="display: none;">
        <div class="modal-content">
            <h2 id="seedCodeModalTitle"></h2>
            <textarea id="seedCodeTextarea" readonly></textarea>
            <div class="flex-row-buttons">
                <button id="copySeedCodeButton" class="bg-gray-500 text-white p-2 rounded hover:bg-gray-600 hidden">Copy Code</button>
                <button id="loadSeedCodeButton" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600 hidden">Load Encounter</button>
                <button id="closeSeedCodeModalButton" class="bg-red-500 text-white p-2 rounded hover:bg-red-600">Close</button>
            </div>
        </div>
    </div>

    <!-- Custom Message Box Modal -->
    <div id="messageBoxModal" class="hidden">
        <div class="message-content">
            <h2 id="messageBoxTitle"></h2>
            <p id="messageBoxContent" class="mb-4"></p>
            <button id="messageBoxCloseButton">OK</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden">
        <div class="spinner"></div>
    </div>

    <div class="container mx-auto p-4">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-center">D&D 5e Monster Tracker</h1>
            <div class="flex items-center gap-4">
                <button id="settingsButton" class="settings-button">
                    <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.06-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.56-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.3-.06.62-.06.94s.02.64.06.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                    </svg>
                </button>
                <div id="settingsPanel" class="hidden">
                    <div class="flex flex-col gap-4">
                        <span id="modeToggle" class="mode-toggle">
                            <span class="simple-label">Simple</span> | <span class="advanced-label">Advanced</span>
                        </span>
                        <span id="compactToggle" class="compact-toggle hidden sm:inline">
                            <span class="full-label">Full</span> | <span class="compact-label">Compact</span>
                        </span>
                        <label class="switch">
                            <input id="darkModeInput" type="checkbox" />
                            <div class="slider round">
                                <div class="sun-moon">
                                    <svg id="moon-dot-1" class="moon-dot" viewBox="0 0 100 100">
                                        <circle cx="50" cy="50" r="50"></circle>
                                    </svg>
                                    <svg id="moon-dot-2" class="moon-dot" viewBox="0 0 100 100">
                                        <circle cx="50" cy="50" r="50"></circle>
                                    </svg>
                                    <svg id="moon-dot-3" class="moon-dot" viewBox="0 0 100 100">
                                        <circle cx="50" cy="50" r="50"></circle>
                                    </svg>
                                    <svg id="light-ray-1" class="light-ray" viewBox="0 0 100 100">
                                        <circle cx="50" cy="50" r="50"></circle>
                                    </svg>
                                    <svg id="light-ray-2" class="light-ray" viewBox="0 0 100 100">
                                        <circle cx="50" cy="50" r="50"></circle>
                                    </svg>
                                    <svg id="light-ray-3" class="light-ray" viewBox="0 0 100 100">
                                        <circle cx="50" cy="50" r="50"></circle>
                                    </svg>
                                    <svg id="cloud-1" class="cloud-dark" viewBox="0 0 100 100">
                                        <circle cx="50" cy="50" r="50"></circle>
                                    </svg>
                                    <svg id="cloud-2" class="cloud-dark" viewBox="0 0 100 100">
                                        <circle cx="50" cy="50" r="50"></circle>
                                    </svg>
                                    <svg id="cloud-3" class="cloud-dark" viewBox="0 0 100 100">
                                        <circle cx="50" cy="50" r="50"></circle>
                                    </svg>
                                    <svg id="cloud-4" class="cloud-light" viewBox="0 0 100 100">
                                        <circle cx="50" cy="50" r="50"></circle>
                                    </svg>
                                    <svg id="cloud-5" class="cloud-light" viewBox="0 0 100 100">
                                        <circle cx="50" cy="50" r="50"></circle>
                                    </svg>
                                    <svg id="cloud-6" class="cloud-light" viewBox="0 0 100 100">
                                        <circle cx="50" cy="50" r="50"></circle>
                                    </svg>
                                </div>
                                <div class="stars">
                                    <svg id="star-1" class="star" viewBox="0 0 20 20">
                                        <path d="M 0 10 C 10 10,10 10 ,0 10 C 10 10 , 10 10 , 10 20 C 10 10 , 10 10 , 20 10 C 10 10 , 10 10 , 10 0 C 10 10,10 10 ,0 10 Z"></path>
                                    </svg>
                                    <svg id="star-2" class="star" viewBox="0 0 20 20">
                                        <path d="M 0 10 C 10 10,10 10 ,0 10 C 10 10 , 10 10 , 10 20 C 10 10 , 10 10 , 20 10 C 10 10 , 10 10 , 10 0 C 10 10,10 10 ,0 10 Z"></path>
                                    </svg>
                                    <svg id="star-3" class="star" viewBox="0 0 20 20">
                                        <path d="M 0 10 C 10 10,10 10 ,0 10 C 10 10 , 10 10 , 10 20 C 10 10 , 10 10 , 20 10 C 10 10 , 10 10 , 10 0 C 10 10,10 10 ,0 10 Z"></path>
                                    </svg>
                                    <svg id="star-4" class="star" viewBox="0 0 20 20">
                                        <path d="M 0 10 C 10 10,10 10 ,0 10 C 10 10 , 10 10 , 10 20 C 10 10 , 10 10 , 20 10 C 10 10 , 10 10 , 10 0 C 10 10,10 10 ,0 10 Z"></path>
                                    </svg>
                                </div>
                            </div>
                        </label>
                        <button id="saveEncounterButton" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Save Encounter</button>
                        <button id="loadEncounterButton" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Load Encounter</button>
                    </div>
                    <button id="toggleChangelog" class="text-blue-600 hover:underline mt-4">View Changelog</button>
                    <div id="changelogBox" class="text-sm bg-white border border-gray-300 rounded p-3 shadow hidden dark:bg-gray-700 dark:border-gray-500">
                        <p><strong>v1.4 Changes:</strong></p>
                        <ol>
                            <li><span style="text-decoration: underline;">Major Changes:</span>
                                <ol style="list-style-type: lower-alpha;">
                                    <li>Added the ability to save/load encounters in the settings menu.</li>

                                </ol>
                            </li>
                        </ol>                        
                        <p><strong>v1.3 Changes:</strong></p>
                        <ol>
                            <li><span style="text-decoration: underline;">Major Changes:</span>
                                <ol style="list-style-type: lower-alpha;">
                                    <li>Added encounter grouping feature in Advanced mode.</li>
                                    <li>Encounter groups are still visible in both Simple and Advanced modes after switching.</li>
                                    <li>Ungrouped monsters are displayed separately.</li>
                                </ol>
                            </li>
                            <li><span style="text-decoration: underline;">Minor Changes:</span>
                                <ol style="list-style-type: lower-alpha;">
                                    <li>Added a "Get Started" popup which explains the difference in modes.</li>

                                </ol>
                            </li>                        
                        </ol>
                        <p><strong>v1.2 Changes:</strong></p>
                        <ol>
                            <li><span style="text-decoration: underline;">Major Changes:</span>
                                <ol style="list-style-type: lower-alpha;">
                                    <li>Added HP modifier popup when clicking on monster's HP.</li>
                                    <li>Added monster details (modifiers, saving throws, immunities, etc) when clicking on the monster name.</li>
                                </ol>
                            </li>
                        </ol>
                        <p><strong>v1.1 Changes:</strong></p>
                        <ol>
                            <li><span style="text-decoration: underline;">Major Changes:</span>
                                <ol style="list-style-type: lower-roman;">
                                    <li>Introduced Simple/Advanced toggle:
                                        <ol style="list-style-type: lower-roman;">
                                            <li>Enables/disables visibility of "Type" (Monster/Player/NPC) with customizable border color options for monster blocks.</li>
                                            <li>Custom border colors override default Player (blue) and NPC (brown) highlights in Advanced mode.</li>
                                            <li>Toggles visibility of a notes section for each monster.</li>
                                        </ol>
                                    </li>
                                    <li>Added Full/Compact toggle to adjust display size for improved desktop viewing.</li>
                                    <li>Enabled editing of AC, Initiative, and Health after a monster is added.</li>
                                </ol>
                            </li>
                            <li><span style="text-decoration: underline;">Minor Changes:</span>
                                <ol style="list-style-type: lower-alpha;">
                                    <li>Added a cogwheel icon to toggle visibility of settings.</li>
                                    <li>Implemented general performance improvements.</li>
                                    <li>Updated changelog to reflect all v1.1 changes.</li>
                                </ol>
                            </li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <div id="addMonsterFormContainer" class="bg-white p-4 rounded-lg shadow mb-6">
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-semibold">Add Monsters</h2>
                <button id="toggleAddForm" class="text-blue-500 hover:text-blue-700 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="addMonsterForm" class="mt-3 flex flex-col gap-4">
                <label id="encounterContainer" class="flex items-center advanced-field">
                    <input type="text" id="encounterName" placeholder="Encounter Name/Number" class="border p-2 rounded w-full">
                </label>
                <div class="flex items-center gap-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="autoInitiative" checked class="mr-2">
                        <span>Auto Initiative</span>
                    </label>
                    <label id="entityTypeContainer" class="flex items-center advanced-field">
                        <span class="mr-2">Type:</span>
                        <select id="entityType" class="border p-2 rounded">
                            <option value="monster" selected>Monster</option>
                            <option value="player">Player</option>
                            <option value="npc">NPC</option>
                        </select>
                    </label>
                </div>
                <div class="flex flex-col sm:flex-row gap-4 relative">
                    <div class="relative flex-1">
                        <input type="text" id="monsterName" placeholder="Monster Name (e.g., Goblin)"
                            class="border p-2 rounded w-full" oninput="fetchMonsterSuggestions()">
                        <div id="monsterSuggestions" class="hidden"></div>
                    </div>
                    <input type="number" id="monsterCount" placeholder="No. #" min="1" value=""
                        class="border p-2 rounded w-24" oninput="updateIndividualInputs()">
                    <input type="number" id="monsterHP" placeholder="HP" min="1"
                        class="border p-2 rounded w-24" data-single-hp>
                    <input type="number" id="monsterInitiative" placeholder="INIT"
                        class="border p-2 rounded w-24 hidden" data-single-initiative>
                    <label id="borderColorContainer" class="flex items-center advanced-field">
                        <span class="mr-2">Color:</span>
                        <input type="color" id="borderColor" value="#000000" class="border p-1 rounded">
                    </label>
                </div>
                <div id="individualInputs" class="flex flex-col gap-2 hidden"></div>
                <div class="add-button-container gap-2">
                    <button onclick="addMonsters()"
                        class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Add</button>
                </div>
            </div>
        </div>

        <button id="floatingAddButton" class="floating-add-button" style="display: none;">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
        </button>

        <div id="monsterList" class="space-y-4"></div>
    </div>

    <script>
        let monsters = [];
        // monsterData caches monster details fetched from the D&D 5e API
        let monsterData = {};
        let currentMonsterId = null;
        let collapsedEncounters = new Set();

        const darkModeToggle = document.getElementById('darkModeInput');
        const prefersDark = localStorage.getItem('darkMode') === 'true';

        // Apply dark mode preference on load
        if (prefersDark) {
            document.body.classList.add('dark');
            darkModeToggle.checked = true;
        }

        // Event listener for dark mode toggle
        darkModeToggle.addEventListener('change', () => {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('darkMode', isDark);
        });

        const modeToggle = document.getElementById('modeToggle');
        // Initial mode will be set by the pop-up or local storage
        let currentModeIsAdvanced = false;

        // Event listener for simple/advanced mode toggle
        modeToggle.addEventListener('click', () => {
            const isAdvanced = !modeToggle.classList.contains('advanced');
            modeToggle.classList.toggle('advanced', isAdvanced);
            localStorage.setItem('advancedMode', isAdvanced);
            currentModeIsAdvanced = isAdvanced; // Update current mode state
            toggleAdvancedFields(isAdvanced);
            renderMonsters();
        });

        const compactToggle = document.getElementById('compactToggle');
        const prefersCompact = localStorage.getItem('compactMode') === 'true';

        // Apply compact mode preference on load
        if (prefersCompact) {
            document.body.classList.add('compact');
            compactToggle.classList.add('compact');
        }

        // Event listener for compact mode toggle
        compactToggle.addEventListener('click', () => {
            const isCompact = !compactToggle.classList.contains('compact');
            compactToggle.classList.toggle('compact', isCompact);
            document.body.classList.toggle('compact', isCompact);
            localStorage.setItem('compactMode', isCompact);
        });

        const settingsButton = document.getElementById('settingsButton');
        const settingsPanel = document.getElementById('settingsPanel');

        // Toggle settings panel visibility
        settingsButton.addEventListener('click', () => {
            settingsPanel.classList.toggle('hidden');
        });

        // Close settings panel, HP popup, and details popup if clicked outside
        document.addEventListener('click', (event) => {
            if (!settingsPanel.contains(event.target) && !settingsButton.contains(event.target)) {
                settingsPanel.classList.add('hidden');
            }
            const openHPPopup = document.querySelector('.hp-popup[style*="block"]');
            if (openHPPopup && !openHPPopup.contains(event.target) && !event.target.closest('.hp-display')) {
                closeHPPopup();
            }
            const openDetailsPopup = document.querySelector('.details-popup[style*="block"]');
            if (openDetailsPopup && !openDetailsPopup.contains(event.target) && !event.target.closest('.monster-name') && !event.target.closest('.details-icon')) {
                closeDetailsPopup();
            }
            // Close seed code modal if clicked outside
            const seedCodeModal = document.getElementById('seedCodeModal');
            if (!seedCodeModal.classList.contains('hidden') && !seedCodeModal.querySelector('.modal-content').contains(event.target) && !event.target.closest('#saveEncounterButton') && !event.target.closest('#loadEncounterButton')) {
                seedCodeModal.classList.add('hidden');
                seedCodeModal.style.display = 'none'; // Explicitly hide
            }
            // Close message box modal if clicked outside
            const messageBoxModal = document.getElementById('messageBoxModal');
            if (!messageBoxModal.classList.contains('hidden') && !messageBoxModal.querySelector('.message-content').contains(event.target)) {
                hideMessageBox();
            }
        });

        const toggleButton = document.getElementById('toggleChangelog');
        const changelogBox = document.getElementById('changelogBox');

        // Toggle changelog visibility
        toggleButton.addEventListener('click', () => {
            const isVisible = !changelogBox.classList.contains('hidden');
            changelogBox.classList.toggle('hidden');
            toggleButton.textContent = isVisible ? 'View Changelog' : 'Hide Changelog';
        });

        // Show/hide advanced fields based on mode
        function toggleAdvancedFields(isAdvanced) {
            const advancedFields = document.querySelectorAll('.advanced-field');
            advancedFields.forEach(field => field.classList.toggle('hidden', !isAdvanced));
            const notesFields = document.querySelectorAll('.notes-field');
            notesFields.forEach(field => field.classList.toggle('hidden', !isAdvanced));
        }

        const autoInitiativeCheckbox = document.getElementById('autoInitiative');
        const singleInitiativeInput = document.querySelector('[data-single-initiative]');

        // Toggle visibility of manual initiative input
        autoInitiativeCheckbox.addEventListener('change', () => {
            const isAuto = autoInitiativeCheckbox.checked;
            singleInitiativeInput.classList.toggle('hidden', isAuto);
            updateIndividualInputs();
        });

        // Fetch monster suggestions from D&D 5e API
        async function fetchMonsterSuggestions() {
            const query = document.getElementById('monsterName').value.trim();
            if (query.length < 2) {
                document.getElementById('monsterSuggestions').classList.add('hidden');
                return;
            }

            try {
                const response = await axios.get('https://www.dnd5eapi.co/api/monsters');
                const monstersList = response.data.results;
                const filteredMonsters = monstersList.filter(m => m.name.toLowerCase().includes(query.toLowerCase()));

                const suggestionsDiv = document.getElementById('monsterSuggestions');
                suggestionsDiv.innerHTML = '';
                suggestionsDiv.classList.remove('hidden');

                for (const monster of filteredMonsters) {
                    const div = document.createElement('div');
                    div.textContent = monster.name;
                    div.onclick = async () => {
                        document.getElementById('monsterName').value = monster.name;
                        suggestionsDiv.classList.add('hidden');
                        // Fetch full monster details and cache them
                        const monsterResponse = await axios.get(`https://www.dnd5eapi.co${monster.url}`);
                        const monsterDetails = monsterResponse.data;
                        document.getElementById('monsterHP').value = monsterDetails.hit_points || '';
                        monsterData[monster.name.toLowerCase()] = { details: monsterDetails, url: monster.url };
                    };
                    suggestionsDiv.appendChild(div);
                }

                if (filteredMonsters.length === 0) {
                    suggestionsDiv.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error fetching monsters:', error);
            }
        }

        // Toggle add monster form visibility
        document.getElementById('toggleAddForm').addEventListener('click', () => {
            const formContainer = document.getElementById('addMonsterFormContainer');
            const floatingButton = document.getElementById('floatingAddButton');
            formContainer.style.display = 'none';
            floatingButton.style.display = 'flex';
        });

        // Calculate random HP based on hit dice
        function calculateRandomHP(monsterDetails) {
            if (!monsterDetails || !monsterDetails.hit_dice) {
                return Math.max(1, Math.floor(Math.random() * 10) + 1); // Default if hit_dice is missing
            }

            // Parse hit dice (e.g., "2d8 + 4")
            const parts = monsterDetails.hit_dice.match(/(\d+)d(\d+)\s*([+-]\s*\d+)?/);
            if (!parts) {
                return monsterDetails.hit_points || Math.max(1, Math.floor(Math.random() * 10) + 1);
            }

            const numDice = parseInt(parts[1]);
            const dieSize = parseInt(parts[2]);
            const bonus = parts[3] ? parseInt(parts[3].replace(/\s/g, '')) : 0;

            let totalHP = 0;
            for (let i = 0; i < numDice; i++) {
                totalHP += Math.floor(Math.random() * dieSize) + 1;
            }
            totalHP += bonus;

            // Add Constitution modifier if available and not already factored into bonus
            const conMod = monsterDetails.constitution ? Math.floor((monsterDetails.constitution - 10) / 2) : 0;
            if (monsterDetails.hit_points_roll) { // Check if hit_points_roll exists
                // If hit_points_roll exists, assume con mod is already in there.
            } else {
                totalHP += (conMod * numDice); // Apply Con mod per hit die
            }

            return Math.max(1, totalHP);
        }


        // Roll initiative with Dexterity modifier
        function rollInitiative(monsterDetails) {
            const dexMod = monsterDetails && monsterDetails.dexterity
                ? Math.floor((monsterDetails.dexterity - 10) / 2)
                : 0;
            return Math.floor(Math.random() * 20) + 1 + dexMod;
        }

        // Update individual HP/Initiative inputs based on monster count
        function updateIndividualInputs() {
            const count = parseInt(document.getElementById('monsterCount').value) || 1;
            const singleHPInput = document.querySelector('[data-single-hp]');
            const singleInitiativeInput = document.querySelector('[data-single-initiative]');
            const individualInputs = document.getElementById('individualInputs');
            const name = document.getElementById('monsterName').value.trim() || 'Monster';
            const monsterDetails = monsterData[name.toLowerCase()]?.details;
            const defaultHP = calculateRandomHP(monsterDetails);
            const isAutoInitiative = autoInitiativeCheckbox.checked;

            if (count > 1) {
                singleHPInput.classList.add('hidden');
                singleInitiativeInput.classList.add('hidden');
                individualInputs.classList.remove('hidden');
                individualInputs.innerHTML = Array.from({ length: count }, (_, i) => {
                    const randomHP = calculateRandomHP(monsterDetails);
                    return `
                        <div class="flex flex-col sm:flex-row items-center gap-2">
                            <label class="w-32">${name} ${i + 1}:</label>
                            <input type="number" min="1" value="${randomHP}" class="border p-2 rounded w-24 individual-hp" placeholder="HP" required>
                            <input type="number" class="${isAutoInitiative ? 'hidden' : ''} border p-2 rounded w-24 individual-initiative" placeholder="INIT" required>
                        </div>
                    `;
                }).join('');
            } else {
                singleHPInput.classList.remove('hidden');
                singleInitiativeInput.classList.toggle('hidden', isAutoInitiative);
                singleHPInput.value = defaultHP;
                individualInputs.classList.add('hidden');
                individualInputs.innerHTML = '';
            }
        }

        // Add monsters to the tracker
        function addMonsters() {
            const name = document.getElementById('monsterName').value.trim();
            const count = parseInt(document.getElementById('monsterCount').value) || 1;
            const isAutoInitiative = autoInitiativeCheckbox.checked;
            const isAdvanced = currentModeIsAdvanced;
            const entityType = isAdvanced ? document.getElementById('entityType').value : 'monster';
            const borderColor = isAdvanced ? document.getElementById('borderColor').value : null; // Use null if default
            const encounterName = isAdvanced ? document.getElementById('encounterName').value.trim() : '';

            if (!name) {
                showMessageBox('Error', 'Please enter a valid monster name.');
                return;
            }

            let hpValues = [];
            let initiativeValues = [];
            const monsterDetails = monsterData[name.toLowerCase()]?.details;

            if (count === 1) {
                const maxHP = parseInt(document.getElementById('monsterHP').value) || calculateRandomHP(monsterDetails);
                const initiative = isAutoInitiative
                    ? rollInitiative(monsterDetails)
                    : parseInt(document.getElementById('monsterInitiative').value) || 0;
                if (maxHP <= 0) {
                    showMessageBox('Error', 'Please enter a valid HP value.');
                    return;
                }
                hpValues.push(maxHP);
                initiativeValues.push(initiative);
            } else {
                const hpInputs = document.querySelectorAll('.individual-hp');
                const initiativeInputs = document.querySelectorAll('.individual-initiative');
                hpValues = Array.from(hpInputs).map(input => parseInt(input.value) || 1);
                initiativeValues = isAutoInitiative
                    ? Array(count).fill().map(() => rollInitiative(monsterDetails))
                    : Array.from(initiativeInputs).map(input => parseInt(input.value) || 0);
                if (hpValues.some(hp => hp <= 0)) {
                    showMessageBox('Error', 'Please enter valid HP values for all monsters.');
                    return;
                }
            }

            for (let i = 0; i < count; i++) {
                const monster = {
                    id: Date.now() + i, // Unique ID
                    name: `${name}${count > 1 ? ` ${i + 1}` : ''}`,
                    maxHP: hpValues[i],
                    currentHP: hpValues[i],
                    initiative: initiativeValues[i],
                    ac: monsterDetails?.armor_class?.[0]?.value || 10, // Default AC to 10
                    entityType: entityType,
                    notes: '',
                    borderColor: borderColor !== '#000000' ? borderColor : null, // Store null if default black
                    apiUrl: monsterData[name.toLowerCase()]?.url || null, // Store API URL if available
                    encounter: encounterName || null
                };
                monsters.push(monster);
            }

            // Clear form fields
            document.getElementById('monsterName').value = '';
            document.getElementById('monsterHP').value = '';
            document.getElementById('monsterInitiative').value = '';
            document.getElementById('monsterCount').value = '';
            document.getElementById('entityType').value = 'monster';
            document.getElementById('borderColor').value = '#000000';
            document.getElementById('encounterName').value = '';
            document.getElementById('individualInputs').innerHTML = '';
            document.querySelector('[data-single-hp]').classList.remove('hidden');
            document.querySelector('[data-single-initiative]').classList.toggle('hidden', isAutoInitiative);
            document.getElementById('individualInputs').classList.add('hidden');
            document.getElementById('monsterSuggestions').classList.add('hidden');
            renderMonsters();
        }

        // Adjust HP by a given amount
        function adjustHP(id, amount) {
            const monster = monsters.find(m => m.id === id);
            if (monster) {
                monster.currentHP = Math.max(0, Math.min(monster.maxHP, monster.currentHP + amount));
                renderMonsters();
            }
        }

        // Adjust HP from the popup
        function adjustPopupHP(id, amount) {
            const monster = monsters.find(m => m.id === id);
            if (monster) {
                monster.currentHP = Math.max(0, Math.min(monster.maxHP, monster.currentHP + amount));
                renderMonsters();
            }
        }

        // Set HP from the popup input
        function setPopupHP(id) {
            const monster = monsters.find(m => m.id === id);
            if (monster) {
                const input = document.getElementById(`hpInput-${id}`);
                const newHP = parseInt(input.value) || 0;
                monster.currentHP = Math.max(0, Math.min(monster.maxHP, newHP));
                closeHPPopup();
                renderMonsters();
            }
        }

        // Open the HP adjustment popup
        function openHPPopup(id) {
            closeHPPopup();
            closeDetailsPopup();
            currentMonsterId = id;
            const monster = monsters.find(m => m.id === id);
            if (monster) {
                const hpDisplay = document.querySelector(`[data-monster-id="${id}"] .hp-display`);
                hpDisplay.innerHTML = `
                    ${monster.currentHP}/${monster.maxHP} HP
                    <div id="hpPopup-${id}" class="hp-popup">
                        <input type="number" id="hpInput-${id}" class="hp-input" min="0" placeholder="0">
                        <div class="hp-buttons">
                            <button class="decrement" onclick="adjustPopupHP(${id}, -parseInt(document.getElementById('hpInput-${id}').value) || 0)">-X</button>
                            <button class="decrement" onclick="adjustPopupHP(${id}, -10)">-10</button>
                            <button class="decrement" onclick="adjustPopupHP(${id}, -5)">-5</button>
                            <button class="set" onclick="setPopupHP(${id})">SET</button>
                            <button class="increment" onclick="adjustPopupHP(${id}, 5)">+5</button>
                            <button class="increment" onclick="adjustPopupHP(${id}, 10)">+10</button>
                            <button class="increment" onclick="adjustPopupHP(${id}, parseInt(document.getElementById('hpInput-${id}').value) || 0)">+X</button>
                        </div>
                    </div>
                `;
                const popup = document.getElementById(`hpPopup-${id}`);
                popup.style.display = 'block';
                document.getElementById(`hpInput-${id}`).focus();
            }
        }

        // Close the HP adjustment popup
        function closeHPPopup() {
            const openPopup = document.querySelector('.hp-popup[style*="block"]');
            if (openPopup) {
                const id = openPopup.id.replace('hpPopup-', '');
                const monster = monsters.find(m => m.id === parseInt(id));
                if (monster) {
                    const hpDisplay = document.querySelector(`[data-monster-id="${id}"] .hp-display`);
                    hpDisplay.innerHTML = `${monster.currentHP}/${monster.maxHP} HP`;
                }
            }
            currentMonsterId = null;
        }

        // Open monster details popup
        async function openDetailsPopup(id) {
            closeHPPopup();
            closeDetailsPopup();
            const monster = monsters.find(m => m.id === id);
            if (monster) {
                const name = monster.name.replace(/\s*\d+$/, '').toLowerCase();
                let monsterDetails = monsterData[name]?.details;
                if (!monsterDetails && monster.apiUrl) {
                    // Fetch details if not already cached
                    monsterDetails = await fetchMonsterDetails(monster.apiUrl);
                }
                if (!monsterDetails) {
                    console.error(`No details found for monster: ${name}`);
                    const monsterHeader = document.querySelector(`[data-monster-id="${id}"] .monster-name-container`);
                    const detailsPopupDiv = document.createElement('div');
                    detailsPopupDiv.id = `detailsPopup-${id}`;
                    detailsPopupDiv.className = 'details-popup';
                    detailsPopupDiv.innerHTML = `
                        <div class="details-content">
                            <p>No details available for this monster.</p>
                        </div>
                    `;
                    monsterHeader.appendChild(detailsPopupDiv);
                    detailsPopupDiv.style.display = 'block';
                    return;
                }
                const monsterHeader = document.querySelector(`[data-monster-id="${id}"] .monster-name-container`);
                const detailsContent = formatMonsterDetails(monsterDetails);
                const detailsPopupDiv = document.createElement('div');
                detailsPopupDiv.id = `detailsPopup-${id}`;
                detailsPopupDiv.className = 'details-popup';
                detailsPopupDiv.innerHTML = `
                    <div class="details-content">
                        ${detailsContent}
                    </div>
                `;
                monsterHeader.appendChild(detailsPopupDiv);
                detailsPopupDiv.style.display = 'block';
            }
        }

        // Fetch monster details from D&D 5e API and cache them
        async function fetchMonsterDetails(url) {
            try {
                if (!url) return null;
                const response = await axios.get(`https://www.dnd5eapi.co${url}`);
                const monsterDetails = response.data;
                if (!monsterDetails || !monsterDetails.name) {
                    console.error(`Invalid API response for URL: ${url}`);
                    return null;
                }
                const name = monsterDetails.name.toLowerCase();
                monsterData[name] = { details: monsterDetails, url: url };
                return monsterDetails;
            } catch (error) {
                console.error('Error fetching monster details:', error);
                return null;
            }
        }

        // Format monster details for display in the popup
        function formatMonsterDetails(details) {
            if (!details || !details.name) {
                return '<p>No details available.</p>';
            }

            const modifiers = [
                { name: 'Strength', value: details.strength },
                { name: 'Dexterity', value: details.dexterity },
                { name: 'Constitution', value: details.constitution },
                { name: 'Intelligence', value: details.intelligence },
                { name: 'Wisdom', value: details.wisdom },
                { name: 'Charisma', value: details.charisma }
            ].map(stat => {
                const mod = Math.floor((stat.value - 10) / 2);
                return `<li>${stat.name}: ${mod >= 0 ? '+' : ''}${mod}</li>`;
            }).join('');

            const savingThrows = details.proficiencies?.filter(p => p.proficiency.name.includes('Saving Throw')).map(p => {
                const stat = p.proficiency.name.replace('Saving Throw: ', '');
                return `${stat}: ${p.value >= 0 ? '+' : ''}${p.value}`;
            }).join(', ') || 'None';

            const vulnerabilities = details.damage_vulnerabilities?.length > 0
                ? details.damage_vulnerabilities.join(', ')
                : 'None';

            const resistances = details.damage_resistances?.length > 0
                ? details.damage_resistances.join(', ')
                : 'None';

            const immunities = details.damage_immunities?.length > 0
                ? details.damage_immunities.join(', ')
                : 'None';

            const conditionImmunities = details.condition_immunities?.length > 0
                ? details.condition_immunities.map(c => c.name).join(', ')
                : 'None';

            const actions = details.actions?.map(action => {
                let desc = `<strong>${action.name}</strong>`;
                if (action.attack_bonus) {
                    desc += ` (Attack Bonus: +${action.attack_bonus})`;
                }
                if (action.damage && action.damage.length > 0) {
                    const damage = action.damage.map(d => {
                        let damageText = `<span class="dice">${d.damage_dice}</span>`;
                        if (d.damage_type && d.damage_type.name) {
                            damageText += ` ${d.damage_type.name}`;
                        }
                        return damageText;
                    }).join(', ');
                    desc += `: ${damage}`;
                }
                desc += `<p>${action.desc}</p>`; // Full description
                return `<li>${desc}</li>`;
            }).join('') || '<p>None</p>';

            const specialAbilities = details.special_abilities?.map(ability => {
                return `<li><strong>${ability.name}</strong>: ${ability.desc}</li>`;
            }).join('') || '<p>None</p>';

            return `
                <h4>Hit Dice</h4>
                <p>${details.hit_dice || 'Unknown'}</p>
                <h4>Ability Modifiers</h4>
                <ul>${modifiers}</ul>
                <h4>Saving Throws</h4>
                <p>${savingThrows}</p>
                <h4>Damage Vulnerabilities</h4>
                <p>${vulnerabilities}</p>
                <h4>Damage Resistances</h4>
                <p>${resistances}</p>
                <h4>Damage Immunities</h4>
                <p>${immunities}</p>
                <h4>Condition Immunities</h4>
                <p>${conditionImmunities}</p>
                <h4>Actions</h4>
                <ul>${actions}</ul>
                <h4>Special Abilities</h4>
                <ul>${specialAbilities}</ul>
            `;
        }

        // Close monster details popup
        function closeDetailsPopup() {
            const openPopup = document.querySelector('.details-popup[style*="block"]');
            if (openPopup) {
                openPopup.remove();
            }
        }

        // Edit initiative inline
        function editInitiative(id) {
            const monster = monsters.find(m => m.id === id);
            if (monster) {
                const card = document.querySelector(`[data-monster-id="${id}"]`);
                const initiativeDisplay = card.querySelector('.initiative-display');

                initiativeDisplay.innerHTML = `
                    <input
                        type="number"
                        id="editInitiative-${id}"
                        value="${monster.initiative}"
                        class="border p-1 rounded w-16"
                    >
                `;

                const input = document.getElementById(`editInitiative-${id}`);

                input.addEventListener('focus', () => {
                    setTimeout(() => {
                        try {
                            input.setSelectionRange(input.value.length, input.value.length);
                        } catch {
                            // Fallback for browsers that don't support setSelectionRange
                            const val = input.value;
                            input.value = '';
                            input.value = val;
                        }
                    }, 0);
                });

                input.focus();

                input.addEventListener('blur', () => saveInitiative(id));
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        saveInitiative(id);
                    }
                });
            }
        }

        // Save edited initiative
        function saveInitiative(id) {
            const monster = monsters.find(m => m.id === id);
            if (monster) {
                const input = document.getElementById(`editInitiative-${id}`);
                if (input) {
                    const newInitiative = parseInt(input.value) || 0;
                    monster.initiative = newInitiative;
                    renderMonsters();
                }
            }
        }

        // Edit AC inline
        function editAC(id) {
            const monster = monsters.find(m => m.id === id);
            if (monster) {
                const card = document.querySelector(`[data-monster-id="${id}"]`);
                const acDisplay = card.querySelector('.ac-display');

                acDisplay.innerHTML = `
                    <input
                        type="number"
                        id="editAC-${id}"
                        value="${monster.ac}"
                        min="1"
                        class="border p-1 rounded w-16"
                    >
                `;

                const input = document.getElementById(`editAC-${id}`);

                input.addEventListener('focus', () => {
                    setTimeout(() => {
                        try {
                            input.setSelectionRange(input.value.length, input.value.length);
                        } catch {
                            const val = input.value;
                            input.value = '';
                            input.value = val;
                        }
                    }, 0);
                });

                input.focus();

                input.addEventListener('blur', () => saveAC(id));
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        saveAC(id);
                    }
                });
            }
        }

        // Save edited AC
        function saveAC(id) {
            const monster = monsters.find(m => m.id === id);
            if (monster) {
                const input = document.getElementById(`editAC-${id}`);
                if (input) {
                    const newAC = parseInt(input.value) || 10;
                    monster.ac = Math.max(1, newAC);
                    renderMonsters();
                }
            }
        }

        // Save notes for a monster
        function saveNotes(id) {
            const monster = monsters.find(m => m.id === id);
            if (monster) {
                const textarea = document.getElementById(`notes-${id}`);
                if (textarea) {
                    monster.notes = textarea.value;
                    renderMonsters();
                }
            }
        }

        // Remove a monster
        function removeMonster(id) {
            monsters = monsters.filter(m => m.id !== id);
            renderMonsters();
        }

        // Toggle encounter group collapse state
        function toggleEncounter(encounter) {
            if (collapsedEncounters.has(encounter)) {
                collapsedEncounters.delete(encounter);
            } else {
                collapsedEncounters.add(encounter);
            }
            renderMonsters();
        }

        // Determine monster status based on HP
        function getStatus(monster) {
            const hpRatio = monster.currentHP / monster.maxHP;
            if (monster.currentHP === 0) return 'Dead';
            if (hpRatio <= 0.25) return 'Critical';
            if (hpRatio <= 0.5) return 'Bloodied';
            if (hpRatio <= 0.75) return 'Injured';
            return 'Healthy';
        }

        // Render all monsters to the display
        function renderMonsters() {
            const list = document.getElementById('monsterList');
            list.innerHTML = '';
            const isAdvanced = currentModeIsAdvanced;

            // Group monsters by encounter
            const groupedMonsters = {};
            monsters.forEach(monster => {
                const encounter = monster.encounter || 'ungrouped';
                if (!groupedMonsters[encounter]) {
                    groupedMonsters[encounter] = [];
                }
                groupedMonsters[encounter].push(monster);
            });

            // Sort groups by encounter name, with ungrouped at the end
            const sortedEncounters = Object.keys(groupedMonsters).sort((a, b) => {
                if (a === 'ungrouped') return 1;
                if (b === 'ungrouped') return -1;
                return a.localeCompare(b);
            });

            sortedEncounters.forEach(encounter => {
                // Sort monsters within each encounter by initiative
                groupedMonsters[encounter].sort((a, b) => {
                    const aIsDead = a.currentHP === 0;
                    const bIsDead = b.currentHP === 0;
                    if (aIsDead && !bIsDead) return 1;
                    if (!aIsDead && bIsDead) return -1;
                    return b.initiative - a.initiative;
                });

                // Create encounter group container
                const encounterDiv = document.createElement('div');
                encounterDiv.className = `encounter-group ${encounter === 'ungrouped' ? 'ungrouped' : ''} ${collapsedEncounters.has(encounter) ? 'collapsed' : ''}`;
                const header = encounter === 'ungrouped' ? '' : `
                    <h2 onclick="toggleEncounter('${encounter}')">
                        <svg class="encounter-toggle-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                        ${encounter}
                    </h2>
                `;
                encounterDiv.innerHTML = header;
                const monsterListDiv = document.createElement('div');
                monsterListDiv.className = 'encounter-monsters space-y-4';

                groupedMonsters[encounter].forEach(monster => {
                    const hpRatio = monster.currentHP / monster.maxHP;
                    const segmentColor = hpRatio <= 0.25 ? '#ff0000' : hpRatio <= 0.5 ? '#ffcc00' : '#22c55e';
                    const segments = Array(monster.maxHP).fill().map((_, i) => `
                        <div class="health-segment ${i < monster.currentHP ? '' : 'empty-segment'}" style="${i < monster.currentHP ? `background-color: ${segmentColor}` : ''}"></div>
                    `).join('');

                    const status = getStatus(monster);
                    const statusColor = {
                        'Healthy': 'text-green-600',
                        'Injured': 'text-yellow-300',
                        'Bloodied': 'text-yellow-600',
                        'Critical': 'text-red-600',
                        'Dead': 'text-gray-600'
                    }[status];

                    const isDead = monster.currentHP === 0;
                    const borderClass = isAdvanced && !monster.borderColor ? (
                        monster.entityType === 'player' ? 'player-border' :
                        monster.entityType === 'npc' ? 'npc-border' : ''
                    ) : (monster.borderColor ? 'custom-border' : '');
                    const borderStyle = monster.borderColor ? `style="--custom-border-color: ${monster.borderColor}"` : '';
                    const cardClasses = `bg-white p-4 rounded-lg shadow flex flex-col gap-2 ${isDead ? 'opacity-50 grayscale' : ''} ${borderClass}`;

                    monsterListDiv.innerHTML += `
                        <div class="${cardClasses}" data-monster-id="${monster.id}" ${borderStyle}>
                            <div class="flex justify-between items-start">
                                <div class="monster-header">
                                    <div class="monster-name-container">
                                        <h3 class="text-lg font-semibold monster-name" onclick="openDetailsPopup(${monster.id})">${monster.name}</h3>
                                        <svg class="details-icon" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" onclick="openDetailsPopup(${monster.id})">
                                            <g id="Page-1" stroke="none" stroke-width="1" fill="currentColor" fill-rule="evenodd">
                                                <g id="Dribbble-Light-Preview" transform="translate(-60.000000, -1919.000000)">
                                                    <g id="icons" transform="translate(56.000000, 160.000000)">
                                                        <path d="M11,1769 L17,1769 L17,1767 L11,1767 L11,1769 Z M11,1765 L17,1765 L17,1763 L11,1763 L11,1765 Z M20,1763 L20,1761 C21.103,1761 22,1761.898 22,1763 L20,1763 Z M18,1775 C18,1776.103 17.103,1777 16,1777 L16,1773 L10,1773 L10,1763 C10,1761.898 10.897,1761 12,1761 L18,1761 L18,1775 Z M14,1777 L8,1777 C6.897,1777 6,1776.103 6,1775 L14,1775 L14,1777 Z M20,1759 L12,1759 C9.791,1759 8,1760.791 8,1763 L8,1773 L4,1773 L4,1775 C4,1777.21 5.791,1779 8,1779 L16,1779 C18.209,1779 20,1777.21 20,1775 L20,1765 L24,1765 L24,1763 C24,1760.791 22.209,1759 20,1759 L20,1759 Z" id="script-[#1601]"></path>
                                                    </g>
                                                </g>
                                            </g>
                                        </svg>
                                    </div>
                                    <div class="ac-initiative">
                                        <span class="ac-display" onclick="editAC(${monster.id})">AC: ${monster.ac}</span>
                                        <span class="initiative-display" onclick="editInitiative(${monster.id})">Init: ${monster.initiative}</span>
                                    </div>
                                </div>
                                <button onclick="removeMonster(${monster.id})" class="remove-button">
                                    <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="flex items-center gap-4">
                                <button onclick="adjustHP(${monster.id}, -1)" class="bg-red-500 text-white p-2 rounded hover:bg-red-600">-</button>
                                <span class="hp-display" onclick="openHPPopup(${monster.id})">${monster.currentHP}/${monster.maxHP} HP</span>
                                <button onclick="adjustHP(${monster.id}, 1)" class="bg-green-500 text-white p-2 rounded hover:bg-green-600">+</button>
                            </div>
                            <div class="health-bar">${segments}</div>
                            <div class="flex flex-col sm:flex-row gap-4 items-start">
                                <span class="${statusColor} font-medium">${status}</span>
                                <div class="flex-1 notes-field ${isAdvanced ? '' : 'hidden'}">
                                    <textarea id="notes-${monster.id}" class="notes-textarea" placeholder="Enter notes..." onblur="saveNotes(${monster.id})" onkeypress="if(event.key === 'Enter' && !event.shiftKey) saveNotes(${monster.id})">${monster.notes}</textarea>
                                </div>
                            </div>
                        </div>
                    `;
                });

                encounterDiv.appendChild(monsterListDiv);
                list.appendChild(encounterDiv);
            });
        }

        const floatingAddButton = document.getElementById('floatingAddButton');
        const addMonsterFormContainer = document.getElementById('addMonsterFormContainer');
        const toggleAddFormButton = document.getElementById('toggleAddForm');
        const modeSelectionPopup = document.getElementById('modeSelectionPopup');
        const getStartedButton = document.getElementById('getStartedButton');
        const neverShowAgainCheckbox = document.getElementById('neverShowAgainCheckbox');
        const simpleModeRadio = document.getElementById('simpleModeRadio');
        const advancedModeRadio = document.getElementById('advancedModeRadio');

        // Elements for seed code modal
        const seedCodeModal = document.getElementById('seedCodeModal');
        const seedCodeModalTitle = document.getElementById('seedCodeModalTitle');
        const seedCodeTextarea = document.getElementById('seedCodeTextarea');
        const copySeedCodeButton = document.getElementById('copySeedCodeButton');
        const loadSeedCodeButton = document.getElementById('loadSeedCodeButton');
        const closeSeedCodeModalButton = document.getElementById('closeSeedCodeModalButton');
        const saveEncounterButton = document.getElementById('saveEncounterButton');
        const loadEncounterButton = document.getElementById('loadEncounterButton');

        // Elements for custom message box
        const messageBoxModal = document.getElementById('messageBoxModal');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageBoxCloseButton = document.getElementById('messageBoxCloseButton');

        // Elements for loading overlay
        const loadingOverlay = document.getElementById('loadingOverlay');

        // Function to display custom message box
        function showMessageBox(title, message) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = message;
            messageBoxModal.classList.remove('hidden');
            messageBoxModal.style.display = 'flex';
        }

        // Function to hide custom message box
        function hideMessageBox() {
            messageBoxModal.classList.add('hidden');
            messageBoxModal.style.display = 'none';
        }

        // Event listener for message box close button
        messageBoxCloseButton.addEventListener('click', hideMessageBox);

        // Function to show loading spinner
        function showLoadingSpinner() {
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.style.display = 'flex';
        }

        // Function to hide loading spinner
        function hideLoadingSpinner() {
            loadingOverlay.classList.add('hidden');
            loadingOverlay.style.display = 'none';
        }

        // Function to initialize the application based on selected mode
        function initializeApp(mode) {
            currentModeIsAdvanced = (mode === 'advanced');
            localStorage.setItem('advancedMode', currentModeIsAdvanced);

            // Update the settings panel toggle display
            modeToggle.classList.toggle('advanced', currentModeIsAdvanced);
            toggleAdvancedFields(currentModeIsAdvanced);

            // Hide the pop-up and show the add monster form
            modeSelectionPopup.classList.add('hidden');
            // Explicitly set display to none to ensure it's hidden
            modeSelectionPopup.style.display = 'none';

            addMonsterFormContainer.style.display = 'block';
            floatingAddButton.style.display = 'none'; // Ensure floating button is hidden initially

            renderMonsters(); // Render any existing monsters based on the selected mode
        }

        // Check local storage on page load
        const savedMode = localStorage.getItem('advancedMode');
        const neverShowAgain = localStorage.getItem('neverShowModeSelection') === 'true';

        // Function to parse URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Initial check for seed in URL on page load
        document.addEventListener('DOMContentLoaded', async () => {
            const seedFromUrl = getUrlParameter('seed');
            if (seedFromUrl) {
                showLoadingSpinner(); // Show spinner immediately if seed is present
                // If a seed is present in the URL, try to load it immediately
                await loadEncounterFromSeed(seedFromUrl);
                hideLoadingSpinner(); // Hide spinner after loading
                // After loading from URL, proceed with normal initialization to handle mode
                if (neverShowAgain && savedMode !== null) {
                    initializeApp(savedMode === 'true' ? 'advanced' : 'simple');
                } else {
                    modeSelectionPopup.classList.remove('hidden');
                    modeSelectionPopup.style.display = 'flex';
                    if (savedMode !== null) {
                        if (savedMode === 'true') {
                            advancedModeRadio.checked = true;
                        } else {
                            simpleModeRadio.checked = true;
                        }
                    }
                }
            } else {
                // If no seed in URL, proceed with normal mode selection logic
                if (neverShowAgain && savedMode !== null) {
                    initializeApp(savedMode === 'true' ? 'advanced' : 'simple');
                } else {
                    modeSelectionPopup.classList.remove('hidden');
                    modeSelectionPopup.style.display = 'flex';
                    if (savedMode !== null) {
                        if (savedMode === 'true') {
                            advancedModeRadio.checked = true;
                        } else {
                            simpleModeRadio.checked = true;
                        }
                    }
                }
            }
        });


        // Event listener for "Get Started" button in mode selection popup
        getStartedButton.addEventListener('click', () => {
            const selectedMode = simpleModeRadio.checked ? 'simple' : 'advanced';

            if (neverShowAgainCheckbox.checked) {
                localStorage.setItem('neverShowModeSelection', 'true');
            } else {
                localStorage.removeItem('neverShowModeSelection');
            }

            initializeApp(selectedMode);
        });

        // Event listener for floating add button
        floatingAddButton.addEventListener('click', () => {
            addMonsterFormContainer.style.display = 'block';
            floatingAddButton.style.display = 'none';
            // Ensure the inner form is visible
            document.getElementById('addMonsterForm').style.display = 'block';
        });

        // Event listener for toggle add form button
        toggleAddFormButton.addEventListener('click', () => {
            addMonsterFormContainer.style.display = 'none';
            floatingAddButton.style.display = 'flex';
        });


        // Function to generate encounter seed code
        function generateEncounterSeed() {
            try {
                // Prepare a simplified array of monster data for serialization
                const serializableMonsters = monsters.map(m => ({
                    id: m.id,
                    name: m.name.replace(/\s*\d+$/, ''), // Store base name
                    currentHP: m.currentHP,
                    maxHP: m.maxHP,
                    initiative: m.initiative,
                    ac: m.ac,
                    entityType: m.entityType,
                    notes: m.notes,
                    borderColor: m.borderColor,
                    encounter: m.encounter,
                    apiUrl: m.apiUrl // Essential for re-fetching full data
                }));
                const jsonString = JSON.stringify(serializableMonsters);
                // Base64 encode the JSON string
                return btoa(jsonString);
            } catch (error) {
                console.error("Error generating encounter seed:", error);
                return "";
            }
        }

        // Function to load encounter from seed code
        async function loadEncounterFromSeed(seedCode) {
            showLoadingSpinner(); // Show spinner at the start of manual load
            try {
                // Base64 decode and parse the JSON string
                const decodedString = atob(seedCode);
                const loadedMonstersData = JSON.parse(decodedString);

                // Clear current monsters and populate with loaded ones
                monsters = [];
                const newMonsterDataCache = {}; // Temporary cache for this load operation

                for (const loadedMonster of loadedMonstersData) {
                    let monsterDetails = null;
                    if (loadedMonster.apiUrl) {
                        const baseName = loadedMonster.name.toLowerCase();
                        if (!newMonsterDataCache[baseName]) {
                            // Fetch full monster details and cache them for this session
                            monsterDetails = await fetchMonsterDetails(loadedMonster.apiUrl);
                        } else {
                            monsterDetails = newMonsterDataCache[baseName].details;
                        }
                    }

                    // Reconstruct monster object, ensuring unique IDs
                    const newMonster = {
                        id: Date.now() + Math.random(), // Assign new unique ID
                        name: loadedMonster.name,
                        maxHP: loadedMonster.maxHP,
                        currentHP: loadedMonster.currentHP,
                        initiative: loadedMonster.initiative,
                        ac: monsterDetails?.armor_class?.[0]?.value || loadedMonster.ac || 10, // Use fetched AC or saved, default to 10
                        entityType: loadedMonster.entityType,
                        notes: loadedMonster.notes,
                        borderColor: loadedMonster.borderColor,
                        apiUrl: loadedMonster.apiUrl,
                        encounter: loadedMonster.encounter
                    };
                    monsters.push(newMonster);
                }
                renderMonsters();
                return true; // Indicate successful load
            } catch (error) {
                console.error("Error loading encounter from seed:", error);
                showMessageBox('Error', 'Invalid seed code. Please check the code and try again.');
                return false; // Indicate failed load
            } finally {
                hideLoadingSpinner(); // Always hide spinner
            }
        }

        // Event listener for Save Encounter button
        saveEncounterButton.addEventListener('click', () => {
            const seed = generateEncounterSeed();
            const currentUrl = window.location.origin + window.location.pathname;
            const shareableUrl = `${currentUrl}?seed=${seed}`;

            seedCodeModalTitle.textContent = "Share This Encounter URL";
            seedCodeTextarea.value = shareableUrl;
            seedCodeTextarea.readOnly = true;
            copySeedCodeButton.classList.remove('hidden');
            loadSeedCodeButton.classList.add('hidden'); // Hide load button
            seedCodeModal.classList.remove('hidden');
            seedCodeModal.style.display = 'flex'; // Explicitly show
        });

        // Event listener for Load Encounter button
        loadEncounterButton.addEventListener('click', () => {
            seedCodeModalTitle.textContent = "Paste Encounter URL to Load";
            seedCodeTextarea.value = ''; // Clear previous code
            seedCodeTextarea.readOnly = false;
            copySeedCodeButton.classList.add('hidden'); // Hide copy button
            loadSeedCodeButton.classList.remove('hidden'); // Show load button
            seedCodeModal.classList.remove('hidden');
            seedCodeModal.style.display = 'flex'; // Explicitly show
            seedCodeTextarea.focus(); // Focus on textarea for pasting
        });

        // Event listener for Copy Seed Code button
        copySeedCodeButton.addEventListener('click', () => {
            seedCodeTextarea.select();
            document.execCommand('copy');
            showMessageBox('Copied!', 'Encounter URL copied to clipboard!');
        });

        // Event listener for Load button inside the modal
        loadSeedCodeButton.addEventListener('click', async () => {
            const url = seedCodeTextarea.value.trim();
            if (url) {
                try {
                    const urlObj = new URL(url);
                    const seed = urlObj.searchParams.get('seed');
                    if (seed) {
                        const success = await loadEncounterFromSeed(seed);
                        if (success) {
                            seedCodeModal.classList.add('hidden');
                            seedCodeModal.style.display = 'none'; // Explicitly hide
                            showMessageBox('Loaded!', 'Encounter loaded successfully from URL!');
                        }
                    } else {
                        showMessageBox('Error', 'No seed found in the provided URL. Please ensure the URL contains a "?seed=" parameter.');
                    }
                } catch (e) {
                    showMessageBox('Error', 'Invalid URL. Please enter a valid URL with an encounter seed.');
                    console.error("URL parsing error:", e);
                }
            } else {
                showMessageBox('Error', 'Please paste a URL to load.');
            }
        });

        // Event listener for Close Seed Code Modal button
        closeSeedCodeModalButton.addEventListener('click', () => {
            seedCodeModal.classList.add('hidden');
            seedCodeModal.style.display = 'none'; // Explicitly hide
        });

    </script>
    <div class="ver text-center mt-4">
        v1.4  Save Encounters!
        <p>Created by Perry</p>
    </div>
</body>
</html>
